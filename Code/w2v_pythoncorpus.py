from pydriller import Repository
from tqdm import tqdm

#collect all python code for building a corpus to train the word2vec model

def read_repo_links(filename):
  names = []
  with open(filename) as f:
    for line in f:
      names.append(line.strip())
  # Get rid of duplicates
  names = list(set(names))
  return names


if __name__ == "__main__":
  import sys
  # Repos we want code from (for LM)
  repos = read_repo_links(sys.argv[1])

  pythontraining = ""
  for r in repos:
    files = []
    iterator = tqdm(Repository(r).traverse_commits())
    iterator.set_description(r)
    for commit in iterator:
        for m in commit.modified_files:
          filename = m.new_path
        
          if filename is not None:
            if ".py" in filename:
              if not filename in files:
                code = m.source_code
                if code is not None:
                  pythontraining = pythontraining + "\n\n" + code
                  files.append(filename)
    
    # Save extracted/relevant code
    with open('w2v/pythontraining.txt', 'w') as outfile:
      outfile.write(pythontraining)
